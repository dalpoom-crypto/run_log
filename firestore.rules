rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자는 자신의 기록 또는 공개 기록을 읽을 수 있습니다
    match /runs/{runId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.isPublic == true || 
         !('isPublic' in resource.data));
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // 사용자 프로필
    match /users/{userId} {
      // 읽기 권한 (닉네임 중복 확인을 위해 로그인하지 않은 사용자도 허용)
      // 개별 문서 읽기 및 컬렉션 쿼리 모두 허용
      allow read: if true; // 닉네임은 공개 정보이므로 모든 사용자가 읽을 수 있음
      // 문서 쓰기: 자신의 문서 또는 크루 승인 시 크루장이 crewId, crewName 업데이트 가능
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        // 크루 승인 시 crewId, crewName만 업데이트 가능
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['crewId', 'crewName']) &&
         request.resource.data.crewId != null &&
         // 해당 크루의 크루장인지 확인
         exists(/databases/$(database)/documents/crews/$(request.resource.data.crewId)) &&
         get(/databases/$(database)/documents/crews/$(request.resource.data.crewId)).data.ownerId == request.auth.uid)
      );
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // 컬렉션
    match /collections/{collectionId} {
      // 로그인한 사용자는 자신의 컬렉션만 접근 가능
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // 팔로우 관계
    match /follows/{followId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.resource.data.followerId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.followerId == request.auth.uid;
    }
    
    // 친구 요청
    match /friendRequests/{requestId} {
      allow read: if request.auth != null && 
        (resource.data.requesterId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.requesterId == request.auth.uid;
      allow update: if request.auth != null && 
        resource.data.receiverId == request.auth.uid;
      allow delete: if request.auth != null && 
        (resource.data.requesterId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
    }
    
    // 친구 관계
    match /friends/{friendId} {
      allow read: if request.auth != null && 
        (resource.data.userId1 == request.auth.uid || 
         resource.data.userId2 == request.auth.uid);
      allow create: if request.auth != null && 
        (request.resource.data.userId1 == request.auth.uid || 
         request.resource.data.userId2 == request.auth.uid);
      allow delete: if request.auth != null && 
        (resource.data.userId1 == request.auth.uid || 
         resource.data.userId2 == request.auth.uid);
    }
    
    // 크루 정보
    match /crews/{crewId} {
      // 로그인한 사용자는 크루 목록을 조회할 수 있음
      allow read: if request.auth != null;
      // 크루 생성: ownerId는 본인 UID여야 함
      allow create: if request.auth != null &&
        request.resource.data.ownerId == request.auth.uid;
      // 크루 수정/삭제: 크루장만 가능 (ownerId)
      allow update, delete: if request.auth != null &&
        resource.data.ownerId == request.auth.uid;
    }
    
    // 크루 멤버십
    match /crewMembers/{memberId} {
      // 로그인한 사용자는 크루 멤버 정보를 조회 가능 (추후 필요 시 제한)
      allow read: if request.auth != null;
      // 멤버 추가: 자신의 멤버십만 생성 (또는 크루장에 의해 생성) 가능
      allow create: if request.auth != null &&
        (request.resource.data.userId == request.auth.uid ||
         request.resource.data.crewOwnerId == request.auth.uid);
      // 멤버 정보 수정/삭제:
      // - 자신의 멤버십은 본인이 가능
      // - crewOwnerId 로 저장된 크루장은 모든 멤버십을 관리 가능
      // - 해당 크루의 크루장도 승인 가능
      allow update: if request.auth != null &&
        (resource.data.userId == request.auth.uid ||
         resource.data.crewOwnerId == request.auth.uid ||
         // 크루장 확인: crews 컬렉션에서 ownerId 확인
         (resource.data.crewId != null &&
          exists(/databases/$(database)/documents/crews/$(resource.data.crewId)) &&
          get(/databases/$(database)/documents/crews/$(resource.data.crewId)).data.ownerId == request.auth.uid));
      allow delete: if request.auth != null &&
        (resource.data.userId == request.auth.uid ||
         resource.data.crewOwnerId == request.auth.uid);
    }

    // 크루 공지사항
    match /crewNotices/{noticeId} {
      // 로그인한 사용자는 크루 공지사항을 조회 가능
      allow read: if request.auth != null;
      // 공지 작성: authorId 가 본인일 때만
      allow create: if request.auth != null &&
        request.resource.data.authorId == request.auth.uid;
      // 공지 수정/삭제: 작성자만 가능
      allow update, delete: if request.auth != null &&
        resource.data.authorId == request.auth.uid;
    }
    
    // 좋아요
    match /likes/{likeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // 댓글
    match /comments/{commentId} {
      // 비밀 댓글은 작성자와 피드 주인만 읽을 수 있음
      allow read: if request.auth != null && (
        !resource.data.isPrivate || 
        resource.data.userId == request.auth.uid ||
        // 피드 주인 확인 (runId로 runs 컬렉션에서 확인)
        // 주의: Firestore 규칙에서는 다른 문서를 직접 읽을 수 없으므로
        // 클라이언트에서 필터링하거나, 댓글에 runOwnerId를 저장해야 함
        true // 임시로 모든 인증된 사용자가 읽을 수 있도록 (클라이언트에서 필터링)
      );
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         // 피드 주인도 댓글을 숨길 수 있도록 (추후 구현)
         false);
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }

    // 스크랩
    match /scraps/{scrapId} {
      // 자신의 스크랩만 읽을 수 있음
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      // 자신의 스크랩만 생성 가능
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      // 자신의 스크랩만 삭제 가능
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }

    // 알림
    match /notifications/{notificationId} {
      // 자신의 알림만 읽을 수 있음
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      // 알림 생성은 시스템에서만 (서버에서만 생성)
      allow create: if request.auth != null;
      // 자신의 알림만 수정 가능 (읽음 처리)
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      // 자신의 알림만 삭제 가능
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // 프로필 사진
    match /profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }
    
    // 러닝 사진
    match /runs/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }

    // 기록증 (대회 기록증 이미지)
    match /certificates/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }
    
    // 지도 이미지
    match /maps/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }

    // 크루 앰블럼 이미지
    match /crewEmblems/{crewId} {
      allow read: if request.auth != null;
      // 인증된 사용자만 업로드 가능 (실제 앱에서는 크루장만 보이도록 UI로 제한)
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }
  }
}
